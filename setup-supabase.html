<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Setup - Campus Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .step {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .step h3 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step p {
            color: #666;
            line-height: 1.6;
        }
        
        .check {
            color: #28a745;
            font-size: 1.2rem;
        }
        
        .cross {
            color: #dc3545;
            font-size: 1.2rem;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
            margin-top: 20px;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .sql-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .copy-btn:hover {
            background: #218838;
        }
        
        .instructions {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0066ff;
            margin: 20px 0;
        }
        
        .instructions h3 {
            color: #0066ff;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #333;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Campus Hub - Supabase Setup</h1>
        <p class="subtitle">Let's get your database ready!</p>
        
        <div id="status" class="status loading">
            <div class="spinner"></div>
            <span>Connecting to Supabase...</span>
        </div>
        
        <div id="steps"></div>
        
        <div id="sql-section" style="display: none;">
            <div class="instructions">
                <h3>üìã Next Steps:</h3>
                <ol>
                    <li>Click the "Copy SQL" button below</li>
                    <li>Go to your <a href="https://supabase.com/dashboard/project/ltxvnsqiufatmtkmrwga/sql/new" target="_blank">Supabase SQL Editor</a></li>
                    <li>Paste the SQL and click "Run"</li>
                    <li>Come back here and click "Verify Setup"</li>
                </ol>
            </div>
            
            <button class="copy-btn" onclick="copySql()">üìã Copy SQL Schema</button>
            <div class="sql-box" id="sql-content"></div>
            
            <button class="btn" onclick="verifySetup()">‚úì Verify Setup</button>
        </div>
        
        <div id="success-section" style="display: none;">
            <div class="step">
                <h3><span class="check">‚úì</span> All Set!</h3>
                <p>Your Supabase database is configured and ready to use.</p>
            </div>
            <a href="index.html" class="btn">üè† Go to Campus Hub</a>
        </div>
    </div>
    
    <script src="js/env.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        let supabaseClient;
        
        const sqlSchema = `-- Campus Hub Database Schema
-- Copy and paste this entire script into Supabase SQL Editor

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Profiles table
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    name TEXT,
    phone TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own profile" ON public.profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update their own profile" ON public.profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Users can insert their own profile" ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);

-- Events table
CREATE TABLE IF NOT EXISTS public.events (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    organizer TEXT NOT NULL,
    event_date DATE NOT NULL,
    location TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view events" ON public.events FOR SELECT USING (true);
CREATE POLICY "Authenticated users can create events" ON public.events FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own events" ON public.events FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own events" ON public.events FOR DELETE USING (auth.uid() = user_id);

-- Jobs table
CREATE TABLE IF NOT EXISTS public.jobs (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    company TEXT NOT NULL,
    job_type TEXT NOT NULL CHECK (job_type IN ('internship', 'part-time', 'full-time')),
    location TEXT NOT NULL,
    skills TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.jobs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view jobs" ON public.jobs FOR SELECT USING (true);
CREATE POLICY "Authenticated users can create jobs" ON public.jobs FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own jobs" ON public.jobs FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own jobs" ON public.jobs FOR DELETE USING (auth.uid() = user_id);

-- Marketplace table
CREATE TABLE IF NOT EXISTS public.marketplace (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    price DECIMAL(10, 2) NOT NULL,
    room_password TEXT NOT NULL,
    status TEXT DEFAULT 'active' CHECK (status IN ('active', 'sold', 'removed')),
    image_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.marketplace ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active marketplace items" ON public.marketplace FOR SELECT USING (status = 'active');
CREATE POLICY "Authenticated users can create marketplace items" ON public.marketplace FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own marketplace items" ON public.marketplace FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own marketplace items" ON public.marketplace FOR DELETE USING (auth.uid() = user_id);

-- Bids table
CREATE TABLE IF NOT EXISTS public.bids (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    item_id UUID REFERENCES public.marketplace(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    amount DECIMAL(10, 2) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.bids ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view bids on their items" ON public.bids FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.marketplace WHERE marketplace.id = bids.item_id AND marketplace.user_id = auth.uid())
    OR auth.uid() = user_id
);
CREATE POLICY "Authenticated users can create bids" ON public.bids FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Feedback table
CREATE TABLE IF NOT EXISTS public.feedback (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    name TEXT NOT NULL,
    email TEXT NOT NULL,
    message TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.feedback ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can submit feedback" ON public.feedback FOR INSERT WITH CHECK (true);
CREATE POLICY "Users can view their own feedback" ON public.feedback FOR SELECT USING (auth.uid() = user_id OR user_id IS NULL);

-- Budget expenses table
CREATE TABLE IF NOT EXISTS public.budget_expenses (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    description TEXT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    category TEXT NOT NULL CHECK (category IN ('food', 'school', 'other')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.budget_expenses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own expenses" ON public.budget_expenses FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can create their own expenses" ON public.budget_expenses FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can delete their own expenses" ON public.budget_expenses FOR DELETE USING (auth.uid() = user_id);

-- Todos table
CREATE TABLE IF NOT EXISTS public.todos (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    text TEXT NOT NULL,
    completed BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.todos ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own todos" ON public.todos FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can create their own todos" ON public.todos FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own todos" ON public.todos FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete their own todos" ON public.todos FOR DELETE USING (auth.uid() = user_id);

-- Rewards table
CREATE TABLE IF NOT EXISTS public.rewards (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    amount DECIMAL(10, 2) NOT NULL,
    reason TEXT NOT NULL,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processed', 'failed')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

ALTER TABLE public.rewards ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own rewards" ON public.rewards FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can create their own rewards" ON public.rewards FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Trigger function for new users
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.profiles (id, name, created_at)
    VALUES (NEW.id, NEW.raw_user_meta_data->>'name', NOW());
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Indexes
CREATE INDEX IF NOT EXISTS idx_events_user_id ON public.events(user_id);
CREATE INDEX IF NOT EXISTS idx_events_date ON public.events(event_date);
CREATE INDEX IF NOT EXISTS idx_jobs_user_id ON public.jobs(user_id);
CREATE INDEX IF NOT EXISTS idx_jobs_type ON public.jobs(job_type);
CREATE INDEX IF NOT EXISTS idx_marketplace_user_id ON public.marketplace(user_id);
CREATE INDEX IF NOT EXISTS idx_marketplace_status ON public.marketplace(status);
CREATE INDEX IF NOT EXISTS idx_bids_item_id ON public.bids(item_id);
CREATE INDEX IF NOT EXISTS idx_bids_user_id ON public.bids(user_id);
CREATE INDEX IF NOT EXISTS idx_budget_user_id ON public.budget_expenses(user_id);
CREATE INDEX IF NOT EXISTS idx_todos_user_id ON public.todos(user_id);
CREATE INDEX IF NOT EXISTS idx_rewards_user_id ON public.rewards(user_id);`;
        
        async function init() {
            const statusEl = document.getElementById('status');
            const stepsEl = document.getElementById('steps');
            
            try {
                // Initialize Supabase
                const { createClient } = supabase;
                supabaseClient = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                
                statusEl.className = 'status success';
                statusEl.innerHTML = '<span class="check">‚úì</span> <span>Connected to Supabase!</span>';
                
                // Check if tables exist
                const { data, error } = await supabaseClient.from('profiles').select('count', { count: 'exact', head: true });
                
                if (error && error.code === '42P01') {
                    // Tables don't exist
                    showSqlSetup();
                } else if (error) {
                    throw error;
                } else {
                    // Tables exist
                    showSuccess();
                }
                
            } catch (error) {
                console.error('Setup error:', error);
                
                if (error.message && error.message.includes('relation') && error.message.includes('does not exist')) {
                    showSqlSetup();
                } else {
                    statusEl.className = 'status error';
                    statusEl.innerHTML = '<span class="cross">‚úó</span> <span>Connection failed: ' + error.message + '</span>';
                }
            }
        }
        
        function showSqlSetup() {
            document.getElementById('sql-section').style.display = 'block';
            document.getElementById('sql-content').textContent = sqlSchema;
        }
        
        function showSuccess() {
            document.getElementById('sql-section').style.display = 'none';
            document.getElementById('success-section').style.display = 'block';
        }
        
        function copySql() {
            navigator.clipboard.writeText(sqlSchema).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            });
        }
        
        async function verifySetup() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Verifying...';
            
            try {
                const { data, error } = await supabaseClient.from('profiles').select('count', { count: 'exact', head: true });
                
                if (error) throw error;
                
                showSuccess();
            } catch (error) {
                alert('Setup not complete. Please run the SQL in Supabase first.');
                btn.disabled = false;
                btn.textContent = '‚úì Verify Setup';
            }
        }
        
        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>